"use strict";var ApplicationConfiguration=function(){var a="freelancemanager",b=["ngResource","ngAnimate","ui.router","ui.bootstrap","ui.utils","oc.lazyLoad"],c=function(b){angular.module(b,[]),angular.module(a).requires.push(b)},d={flot:["lib/flot/jquery.flot.js"],"flot-plugins":["lib/flot/jquery.flot.resize.js","lib/flot/jquery.flot.pie.js"],datetime:["lib/clockpicker/dist/bootstrap-clockpicker.css","lib/bootstrap-datepicker/css/datepicker3.css","lib/clockpicker/dist/bootstrap-clockpicker.js","lib/bootstrap-datepicker/js/bootstrap-datepicker.js"]};return{applicationModuleName:a,applicationModuleVendorDependencies:b,registerModule:c,scripts:d}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function(a){a.hashPrefix("!")}]),angular.element(document).ready(function(){angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),ApplicationConfiguration.registerModule("account"),ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("crm"),ApplicationConfiguration.registerModule("project"),ApplicationConfiguration.registerModule("time"),angular.module("account",["angular-jwt"]).factory("authInterceptor",["$rootScope","$q","$window",function(a,b,c){return{request:function(a){return a.headers=a.headers||{},c.sessionStorage.token&&(a.headers.Authorization="Bearer "+c.sessionStorage.token),a},response:function(a){return 401===a.status,a||b.when(a)}}}]).config(["$httpProvider",function(a){a.interceptors.push("authInterceptor")}]).run(["$rootScope","$location","$window","jwtHelper",function(a,b,c,d){a.$on("$stateChangeStart",function(a,e){var f=c.sessionStorage.token&&!d.isTokenExpired(c.sessionStorage.token);e.access&&e.access.requiredLogin&&!f&&b.path("/login")})}]),angular.module("account").config(["$stateProvider",function(a){a.state("login",{url:"/login",templateUrl:"modules/account/views/login.html"}).state("account",{url:"/account",templateUrl:"modules/account/views/account.html",access:{requiredLogin:!0}})}]),angular.module("account").controller("AccountInfoController",["$scope","$window","jwtHelper","Account",function(a,b,c,d){var e=c.decodeToken(b.sessionStorage.token);d.get({id:e.id}).$promise.then(function(b){a.account=b}),a.save=function(){d.save(e.id,a.account)}}]),angular.module("account").controller("AuthenticateController",["$scope","$http","$window","$location",function(a,b,c,d){a.user={email:"",password:""},a.error="",a.submit=function(){b.post("/security/authenticate",a.user).success(function(a){c.sessionStorage.token=a.token,d.path("/")}).error(function(){delete c.sessionStorage.token,a.error="Invalid email or password"})}}]),angular.module("core").config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("home",{url:"/",templateUrl:"modules/core/views/home.html",access:{requiredLogin:!0}})}]),angular.module("core").controller("HeaderController",["$scope","$window","jwtHelper",function(a,b,c){a.date=new Date;var d=c.decodeToken(b.sessionStorage.token);a.fullName=d.fullName}]),angular.module("core").controller("HomeController",["$scope",function(a){a.date=new Date}]),angular.module("core").directive("fmActiveMenuItem",["$state","$stateParams","$interpolate",function(a){return{restrict:"A",controller:["$scope","$element","$attrs",function(b,c,d){function e(){0==a.$current.self.name.indexOf(f)?c.addClass("active"):c.removeClass("active")}var f;f=d.fmActiveMenuItem||"",b.$on("$stateChangeSuccess",e)}]}}]),angular.module("core").directive("autofocus",["$timeout",function(a){return{link:function(b,c){a(function(){c[0].focus()},100)}}}]),angular.module("core").directive("fmClockpicker",function(){return{restrict:"A",link:function(a,b){b.clockpicker()}}}),angular.module("core").directive("fmDatepicker",["$timeout",function(){return{restrict:"A",require:"?ngModel",scope:{fmDatepickerDatechanged:"&"},link:function(a,b,c,d){if(d){var e=function(b){a.$apply(function(){d.$setViewValue(b)})};d.$render=function(){b.datepicker("setDate",d.$viewValue||"")},b.datepicker({format:c.fmDatepickerFormat||"yyyy-mm-dd",autoclose:!0,orientation:"auto right",todayBtn:"linked"}).on("changeDate",function(b){var d=b.format(c.fmDatepickerFormat||"yyyy-mm-dd");a.$root&&!a.$root.$$phase&&(e(d),a.fmDatepickerDatechanged&&a.$apply(function(){a.fmDatepickerDatechanged({date:d})}))})}}}}]),angular.module("core").directive("piechart",function(){return{restrict:"E",link:function(a,b,c){var d=null,e={series:{pie:{show:!0,radius:1,label:{show:!0,radius:2/3,formatter:function(a,b){return"<div style='font-size:8pt; text-align:center; padding:2px; color:white;'>"+a+"<br/>"+Math.round(b.percent)+"%</div>"},threshold:.1}}},legend:{show:!1}};a.$watch(c.ngModel,function(a){d?(d.setData(a),d.setupGrid(),d.draw()):a&&(d=$.plot(b,a,e),b.show())})}}}),angular.module("core").factory("Account",["$resource",function(a){return a("/api/public/accounts/:id",{id:"@id"})}]),angular.module("core").factory("Company",["$resource",function(a){return a("/api/public/companies/:id",{id:"@id"})}]),angular.module("core").factory("Invoice",["$resource",function(a){return a("/api/public/invoices/:id",{id:"@id"})}]),angular.module("core").factory("Project",["$resource",function(a){return a("/api/public/projects/:id",{id:"@id"},{active:{method:"GET",url:"/api/public/projects/active",isArray:!0},hide:{method:"POST",url:"/api/public/projects/:id/hide",isArray:!1},unhide:{method:"POST",url:"/api/public/projects/:id/unhide",isArray:!1},changetasks:{method:"POST",url:"/api/public/projects/:id/changetasks",isArray:!1}})}]),angular.module("core").factory("TimeRegistration",["$resource",function(a){return a("/api/public/timeregistrations/:id",{id:"@id"},{bydate:{method:"GET",url:"/api/public/timeregistrations/bydate/:date",params:{date:"@date"},isArray:!0},byrange:{method:"GET",url:"/api/public/timeregistrations/byrange/:from/:to",params:{from:"@from",to:"@to"},isArray:!0},uninvoiced:{method:"GET",url:"/api/public/timeregistrations/uninvoiced",isArray:!0},getinfo:{method:"GET",url:"/api/public/timeregistrations/getinfo/:from/:to",params:{from:"@from",to:"@to"}}})}]),angular.module("core").factory("XLSXReader",["$q","$rootScope",function(a){function b(a){var b={};return _.forEachRight(a.SheetNames,function(d){var e=a.Sheets[d];b[d]=c(e)}),b}function c(a){var b=XLSX.utils.decode_range(a["!ref"]),c=[],d=[];return _.forEachRight(_.range(b.s.r,b.e.r+1),function(e){var f=[];_.forEachRight(_.range(b.s.c,b.e.c+1),function(b){var c=XLSX.utils.encode_cell({c:b,r:e}),d=a[c];f[b]=d?d.v:void 0}),0==e?d=f:c[e-1]=f}),{header:d,data:c,name:a.name,col_size:b.e.c+1,row_size:b.e.r}}var d=function(a){angular.extend(this,a)};return d.readFile=function(c){var d=a.defer(),e=new FileReader;return e.onload=function(a){var c=a.target.result,e=XLSX.read(c,{type:"binary"});d.resolve(b(e))},e.readAsBinaryString(c),d.promise},d}]),angular.module("core").filter("formatdate",function(){return function(a){return _.has(a,"year")&&_.has(a,"month")&&_.has(a,"day")?a.year+"-"+("00"+a.month).slice(-2)+"-"+("00"+a.day).slice(-2):"-"}}),angular.module("core").filter("formattime",function(){return function(a){if(_.has(a,"hour")&&_.has(a,"minutes"))return("00"+a.hour).slice(-2)+":"+("00"+a.minutes).slice(-2);if(_.isNumber(a)){var b=Math.floor(a/60),c=Math.floor(a-60*b);return b>99?b+":"+("00"+c).slice(-2):("00"+b).slice(-2)+":"+("00"+c).slice(-2)}return"-"}}),angular.module("core").filter("moment",function(){return function(a,b){return a.format(b)}}),angular.module("core").service("Menus",[function(){this.defaultRoles=["user"],this.menus={};var a=function(a){if(!a)return this.isPublic;for(var b in a.roles)for(var c in this.roles)if(this.roles[c]===a.roles[b])return!0;return!1};this.validateMenuExistance=function(a){if(a&&a.length){if(this.menus[a])return!0;throw new Error("Menu does not exists")}throw new Error("MenuId was not provided")},this.getMenu=function(a){return this.validateMenuExistance(a),this.menus[a]},this.addMenu=function(b,c,d){return this.menus[b]={isPublic:c||!1,roles:d||this.defaultRoles,items:[],shouldRender:a},this.menus[b]},this.removeMenu=function(a){this.validateMenuExistance(a),delete this.menus[a]},this.addMenuItem=function(b,c,d,e,f,g,h){return this.validateMenuExistance(b),this.menus[b].items.push({title:c,link:d,menuItemType:e||"item",menuItemClass:e,uiRoute:f||"/"+d,isPublic:g||this.menus[b].isPublic,roles:h||this.defaultRoles,items:[],shouldRender:a}),this.menus[b]},this.addSubMenuItem=function(b,c,d,e,f,g,h){this.validateMenuExistance(b);for(var i in this.menus[b].items)this.menus[b].items[i].link===c&&this.menus[b].items[i].items.push({title:d,link:e,uiRoute:f||"/"+e,isPublic:g||this.menus[b].isPublic,roles:h||this.defaultRoles,shouldRender:a});return this.menus[b]},this.removeMenuItem=function(a,b){this.validateMenuExistance(a);for(var c in this.menus[a].items)this.menus[a].items[c].link===b&&this.menus[a].items.splice(c,1);return this.menus[a]},this.removeSubMenuItem=function(a,b){this.validateMenuExistance(a);for(var c in this.menus[a].items)for(var d in this.menus[a].items[c].items)this.menus[a].items[c].items[d].link===b&&this.menus[a].items[c].items.splice(d,1);return this.menus[a]},this.addMenu("topbar")}]),angular.module("crm").config(["$stateProvider",function(a){a.state("crm",{templateUrl:"modules/crm/views/crm.html",access:{requiredLogin:!0}}).state("crm.companies",{url:"/companies",templateUrl:"modules/crm/views/companies.html",access:{requiredLogin:!0}})}]),angular.module("crm").controller("CompaniesController",["$scope","$modal","Company",function(a,b,c){a.getAllCompanies=function(){a.companies=c.query()},a.openCompany=function(c){var d=b.open({templateUrl:"/modules/crm/views/companydialog.html",controller:"CompanyDialogController",resolve:{toUpdate:function(){return c}}});d.result.then(function(b){var c=_.find(a.companies,{id:b.id});c?angular.copy(b,c):a.companies.push(b)})}}]),angular.module("crm").controller("CompanyDialogController",["$scope","Company","toUpdate",function(a,b,c){function d(b){a.isBusy=!0,a.message=b}function e(){a.isBusy=!1,a.message=""}a.originalCompany=c,a.newCompany=void 0==c,c=c||{},a.company={name:c.name||""},a.isBusy=!1,a.message="",a.ok=function(){d("Saving company...");var c=a.newCompany?{}:{id:a.originalCompany.id};b.save(c,a.company,function(b){e(),a.$close(b)},function(){d("An error occurred...")})},a.cancel=function(){a.$dismiss("cancel")}}]),angular.module("project").config(["$stateProvider",function(a){a.state("project",{templateUrl:"modules/project/views/project.html",access:{requiredLogin:!0}}).state("project.projects",{url:"/projects",templateUrl:"modules/project/views/projects.html",access:{requiredLogin:!0}})}]),angular.module("project").controller("ProjectDialogController",["$scope","Project","Company","toUpdate",function(a,b,c,d){function e(b){a.isBusy=!0,a.message=b}function f(){a.isBusy=!1,a.message=""}a.originalProject=d,a.newProject=void 0==d,d=d||{},a.project={companyId:d.companyId||"",name:d.name||"",description:d.description||""},a.isBusy=!1,a.message="",a.companies=c.query(),a.ok=function(){e("Saving project...");var c=a.newProject?{}:{id:a.originalProject.id};b.save(c,a.project,function(b){f(),a.$close(b)},function(){e("An error occurred...")})},a.cancel=function(){a.$dismiss("cancel")}}]),angular.module("project").controller("ProjectsController",["$scope","$modal","Project",function(a,b,c){a.getAllProjects=function(){a.projects=c.query()},a.openProject=function(c){var d=b.open({templateUrl:"/modules/project/views/projectdialog.html",controller:"ProjectDialogController",resolve:{toUpdate:function(){return c}}});d.result.then(function(b){var c=_.find(a.projects,{id:b.id});c?angular.copy(b,c):a.projects.push(b)})},a.openProjectTasks=function(c){var d=b.open({templateUrl:"/modules/project/views/projecttasksdialog.html",controller:"ProjectTasksDialogController",resolve:{toUpdate:function(){return c}}});d.result.then(function(b){var c=_.find(a.projects,{id:b.id});c&&angular.copy(b,c)})},a.hideProject=function(a){c.hide({id:a.id},function(){a.hidden=!0})},a.unhideProject=function(a){c.unhide({id:a.id},function(){a.hidden=!1})}}]),angular.module("project").controller("ProjectTasksDialogController",["$scope","Project","toUpdate",function(a,b,c){function d(b){a.isBusy=!0,a.message=b}function e(){a.isBusy=!1,a.message=""}a.originalProject=c,c=c||{},a.project={tasks:_.map(c.tasks,function(a){return{name:a.name,defaultRateInCents:a.defaultRateInCents}})},a.isBusy=!1,a.message="",a.ok=function(){d("Saving project..."),b.changetasks({id:a.originalProject.id},a.project.tasks,function(b){e(),a.$close(b)},function(){d("An error occurred...")})},a.cancel=function(){a.$dismiss("cancel")}}]),angular.module("time").config(["$stateProvider","$urlRouterProvider","$ocLazyLoadProvider",function(a,b,c){function d(){var a=arguments;return{deps:["$ocLazyLoad","$q",function(b,c){function d(a){return f.then("function"==typeof a?a:function(){var c=e(a);return c?b.load(c):$.error("Route resolve: Bad resource name ["+a+"]")})}function e(a){return ApplicationConfiguration.scripts&&ApplicationConfiguration.scripts[a]}for(var f=c.when(1),g=0,h=a.length;h>g;g++)f=d(a[g]);return f}]}}c.config({debug:!1,events:!0}),a.state("time",{templateUrl:"modules/time/views/time.html",access:{requiredLogin:!0}}).state("time.overview",{url:"/time/overview/:from/:to",templateUrl:"modules/time/views/overview.html",access:{requiredLogin:!0},resolve:d("datetime")}).state("time.registrations",{url:"/time/registrations/:date",templateUrl:"modules/time/views/registrations.html",access:{requiredLogin:!0},resolve:d("datetime")}).state("time.report",{url:"/time/report/:from/:to",templateUrl:"modules/time/views/report.html",access:{requiredLogin:!0},resolve:d("flot","flot-plugins")}).state("time.import",{url:"/time/import",templateUrl:"modules/time/views/import.html",access:{requiredLogin:!0}})}]),angular.module("time").controller("ImportController",["$scope","XLSXReader","Project","TimeRegistration",function(a,b,c,d){function e(a){return parseInt(a.replace(/-/g,""),10)}function f(a){return parseInt(a.replace(":",""),10)}a.wizardStep=1,c.active(function(b){var c=[],d=0;_.forEach(b,function(a){_.forEach(a.tasks,function(b){c.push({project:a,task:b,display:a.name+" - "+b.name,id:d++})})}),a.tasks=c}),a.fileChanged=function(c){a.excelSheets=[],a.excelFile=c[0],b.readFile(a.excelFile,a.showPreview).then(function(b){a.excelSheets=b,a.gotoStep2()})},a.gotoStep2=function(){a.wizardStep+=1},a.canGotoStep2=function(){return!0},a.selectedSheetName=void 0,a.selectedSheet=void 0,a.gotoStep3=function(){a.selectedSheet=a.excelSheets[a.selectedSheetName];for(var b=[],c=0;c<a.selectedSheet.header.length;c++)b.push({key:c,value:a.selectedSheet.header[c]});a.selectedSheetHeader=b,a.wizardStep+=1},a.canGotoStep3=function(){return null!=a.selectedSheetName},a.gotoStep4=function(){a.groupedRows=_.groupBy(a.selectedSheet.data,function(b){return b[a.selectedProjectColumn]+" - "+b[a.selectedTaskColumn]}),a.projectsInExcelSheet=_.map(a.groupedRows,function(b){return{project:b[0][a.selectedProjectColumn],task:b[0][a.selectedTaskColumn],display:b[0][a.selectedProjectColumn]+" - "+b[0][a.selectedTaskColumn]}}),a.wizardStep+=1},a.canGotoStep4=function(){return null!=a.selectedProjectColumn&&null!=a.selectedTaskColumn&&null!=a.selectedDateColumn&&null!=a.selectedFromColumn&&null!=a.selectedToColumn&&null!=a.selectedDescriptionColumn},a.gotoStep5=function(){a.wizardStep+=1},a.canGotoStep5=function(){return _.every(a.projectsInExcelSheet,function(a){return null!=a.mappedProjectAndTask})},a["import"]=function(){var b=[];_.forEach(a.groupedRows,function(c){var d=_.first(_.where(a.projectsInExcelSheet,function(b){return b.project==c[0][a.selectedProjectColumn]&&b.task==c[0][a.selectedTaskColumn]})).mappedProjectAndTask,g=a.tasks[d].project,h=a.tasks[d].task;_.forEach(c,function(c){b.push({companyId:g.companyId,projectId:g.id,task:h.name,description:c[a.selectedDescriptionColumn],date:e(c[a.selectedDateColumn]),from:f(c[a.selectedFromColumn]),to:f(c[a.selectedToColumn])})})}),d.save(b,function(){},function(){})}}]),angular.module("time").controller("OverviewController",["$scope","$location","$stateParams","TimeRegistration",function(a,b,c,d){a.from=new moment(c.from,"YYYYMMDD"),a.to=new moment(c.to,"YYYYMMDD"),a.hasTimeRegistrations=!1,a.from=new moment(c.from,"YYYYMMDD"),a.to=new moment(c.to,"YYYYMMDD"),a.thisWeek=(new moment).day(1).format("YYYYMMDD")+"/"+(new moment).day(7).format("YYYYMMDD"),a.lastWeek=(new moment).day(1).subtract("days",7).format("YYYYMMDD")+"/"+(new moment).day(7).subtract("days",7).format("YYYYMMDD"),a.thisMonth=(new moment).set("date",1).format("YYYYMMDD")+"/"+(new moment).set("date",(new moment).daysInMonth()).format("YYYYMMDD"),a.lastMonth=(new moment).set("date",1).subtract("months",1).format("YYYYMMDD")+"/"+(new moment).subtract("months",1).set("date",(new moment).subtract("months",1).daysInMonth()).format("YYYYMMDD"),a.thisYear=(new moment).set("month",0).set("date",1).format("YYYYMMDD")+"/"+(new moment).set("month",11).set("date",31).format("YYYYMMDD"),a.lastYear=(new moment).set("month",0).set("date",1).subtract("years",1).format("YYYYMMDD")+"/"+(new moment).set("month",11).set("date",31).subtract("years",1).format("YYYYMMDD"),a.$watch("from",function(){a.displayFrom=a.from.format("YYYY-MM-DD")}),a.$watch("to",function(){a.displayTo=a.to.format("YYYY-MM-DD")}),a.changeFrom=function(b,c){a.from=new moment(b,c)},a.changeTo=function(b,c){a.to=new moment(b,c)},a.applyDate=function(){b.path("/time/overview/"+a.from.format("YYYYMMDD")+"/"+a.to.format("YYYYMMDD")).replace()},a.refresh=function(){d.byrange({from:a.from.format("YYYYMMDD"),to:a.to.format("YYYYMMDD")},function(b){var c=_.groupBy(b,function(a){return a.date.numeric});a.timeRegistrations=_.sortBy(_.map(c,function(a){return{date:_.first(a).date,items:a}}),function(a){return a.date.numeric}),a.hasTimeRegistrations=a.timeRegistrations.length>0})}}]),angular.module("time").controller("RegistrationsController",["$scope","$modal","$location","$stateParams","TimeRegistration",function(a,b,c,d,e){a.date=new moment(d.date,"YYYYMMDD"),a.hasTimeRegistrations=!1,a.$watch("date",function(){a.displayDate=a.date.format("YYYY-MM-DD")}),a.nextDate=function(){a.date=new moment(a.date.add(1,"days")),c.path("/time/registrations/"+a.date.format("YYYYMMDD")).replace(),a.refresh()},a.previousDate=function(){a.date=new moment(a.date.subtract(1,"days")),c.path("/time/registrations/"+a.date.format("YYYYMMDD")).replace(),a.refresh()},a.changeDate=function(b,d){a.date=new moment(b,d),c.path("/time/registrations/"+a.date.format("YYYYMMDD")).replace(),a.refresh()},a.refresh=function(){e.bydate({date:a.date.format("YYYYMMDD")},function(b){a.hasTimeRegistrations=b.length>0,a.timeRegistrations=_.sortBy(b,function(a){return a.from.numeric})})},a.openTimeRegistration=function(c){var d=b.open({templateUrl:"/modules/time/views/timeregistrationdialog.html",controller:"TimeRegistrationDialogController",size:"lg",resolve:{toUpdate:function(){return c},date:function(){return a.date.format("YYYYMMDD")}}});d.result.then(function(b){var c=_.find(a.timeRegistrations,{id:b.id});c?angular.copy(b,c):a.timeRegistrations.push(b),a.hasTimeRegistrations=a.timeRegistrations.length>0})}}]),angular.module("time").controller("ReportController",["$scope","$location","$stateParams","TimeRegistration",function(a,b,c,d){if(a.from=new moment(c.from,"YYYYMMDD"),a.to=new moment(c.to,"YYYYMMDD"),1==a.from.date()&&0==a.from.month()&&31==a.to.date()&&11==a.to.month()&&a.from.year()==a.to.year())a.title=a.from.format("YYYY"),a.previousFrom=new moment(a.from).subtract(1,"year"),a.previousTo=new moment(a.to).subtract(1,"year"),a.nextFrom=new moment(a.from).add(1,"year"),a.nextTo=new moment(a.to).add(1,"year");else if(1==a.from.date()&&new moment(a.from).endOf("month").date()==a.to.date()&&a.from.month()==a.to.month()&&a.from.year()==a.to.year())a.title=a.from.format("MMMM YYYY"),a.previousFrom=new moment(a.from).subtract(1,"month").startOf("month"),a.previousTo=new moment(a.from).subtract(1,"month").endOf("month"),a.nextFrom=new moment(a.from).add(1,"month").startOf("month"),a.nextTo=new moment(a.from).add(1,"month").endOf("month");else{a.title=a.from.format("YYYY-MM-DD")+" - "+a.to.format("YYYY-MM-DD");var e=a.to.diff(a.from,"days")+1;a.previousFrom=new moment(a.from).subtract(e,"days"),a.previousTo=new moment(a.to).subtract(e,"days"),a.nextFrom=new moment(a.from).add(e,"days"),a.nextTo=new moment(a.to).add(e,"days")}a.weekStart=(new moment).startOf("isoWeek").format("YYYYMMDD"),a.weekEnd=(new moment).endOf("isoWeek").format("YYYYMMDD"),a.monthStart=(new moment).startOf("month").format("YYYYMMDD"),a.monthEnd=(new moment).endOf("month").format("YYYYMMDD"),a.yearStart=(new moment).startOf("year").format("YYYYMMDD"),a.yearEnd=(new moment).endOf("year").format("YYYYMMDD"),a.previous=function(){b.path("/time/report/"+a.previousFrom.format("YYYYMMDD")+"/"+a.previousTo.format("YYYYMMDD")).replace()},a.next=function(){b.path("/time/report/"+a.nextFrom.format("YYYYMMDD")+"/"+a.nextTo.format("YYYYMMDD")).replace()},a.refresh=function(){a.loading=!0,d.getinfo({from:a.from.format("YYYYMMDD"),to:a.to.format("YYYYMMDD")}).$promise.then(function(b){a.summary=b.summary;var c=_.groupBy(b.perTask,function(a){return JSON.stringify({c:a.companyId,p:a.projectId})});a.infoPerProject=_.map(c,function(a){return{companyId:a[0].companyId,company:a[0].company,projectId:a[0].projectId,project:a[0].project,tasks:a}})})["finally"](function(){a.billableUnbillableGraph=[{label:"Billable",data:a.summary.billableMinutes,color:"#7266BA"},{label:"Unbillable",data:a.summary.unBillableMinutes,color:"#5D9CEC"}],a.hasHours=a.summary.unBillableMinutes||a.summary.billableMinutes?!0:!1,a.loading=!1})}}]),angular.module("time").controller("TimeController",["$scope","$location","$stateParams",function(a){a.today=new moment,a.firstOfCurrentMonth=(new moment).startOf("month"),a.lastOfCurrentMonth=(new moment).endOf("month")}]),angular.module("time").controller("TimeRegistrationDialogController",["$scope","Project","TimeRegistration","toUpdate","date",function(a,b,c,d,e){function f(b){a.isBusy=!0,a.message=b}function g(){a.isBusy=!1,a.message=""}function h(a){var b=Math.floor(a/100),c=Math.floor(a-100*b);return("00"+b).slice(-2)+":"+("00"+c).slice(-2)}function i(a){return parseInt(a.replace(":",""),10)}a.originalTimeRegistration=d,a.newTimeRegistration=void 0==d,d=d||{},a.timeRegistration={company:null,project:null,task:null,billable:d.billable||!1,description:d.description||"",from:d.from?h(d.from.numeric):"",to:d.to?h(d.to.numeric):""},a.$watch("timeRegistration.company",function(b,c){c&&b&&c.id!=b.id&&(a.timeRegistration.project=null,a.timeRegistration.task=null)}),a.$watch("timeRegistration.project",function(b,c){c&&b&&c.id!=b.id&&(a.timeRegistration.task=null)}),a.$watch("timeRegistration.task",function(){a.newTimeRegistration&&a.timeRegistration.task&&(a.timeRegistration.billable=a.timeRegistration.task.defaultRateInCents>0)}),a.isBusy=!1,a.message="",a.projects=b.active(function(){a.companies=_.map(_.groupBy(a.projects,function(a){return a.companyId}),function(a){return{id:a[0].companyId,name:a[0].company.name,projects:a}}),d.companyId&&(a.timeRegistration.company=_.first(_.where(a.companies,{id:d.companyId}))),d.projectId&&a.timeRegistration.company&&(a.timeRegistration.project=_.first(_.where(a.timeRegistration.company.projects,{id:d.projectId}))),d.task&&a.timeRegistration.project&&(a.timeRegistration.task=_.first(_.where(a.timeRegistration.project.tasks,{name:d.task}))),a.$apply()}),a.ok=function(){f("Saving time registration...");var b=a.newTimeRegistration?{}:{id:a.originalTimeRegistration.id};c.save(b,{companyId:a.timeRegistration.company.id,projectId:a.timeRegistration.project.id,task:a.timeRegistration.task.name,description:a.timeRegistration.description,billable:a.timeRegistration.billable,date:e,from:i(a.timeRegistration.from),to:i(a.timeRegistration.to)},function(b){g(),a.$close(b)},function(){f("An error occurred...")})},a.cancel=function(){a.$dismiss("cancel")}}]);